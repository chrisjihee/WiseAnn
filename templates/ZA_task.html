{% extends "index.html" %}

{% block script_header %}
    <script type="text/javascript">
        var autosave = undefined;
        var taskdone = undefined;

        if (!getAuthCode())
            window.location = "/login/";
        $.ajax({
            url: "/ZA/",
            type: "get",
            async: true,
            beforeSend: function (req) {
                req.setRequestHeader("Authorization", authcode);
            }
        });

        const goList = function () {
            window.location = "/ZA/";
        };

        const showDeps = function (i) {
            $("div#" + i + ".deps").slideToggle("slow");
        };

        const addAnte = function (i, x) {
            $("table#" + i + ".sent .btn-group input:checked").closest(".btn-group").addClass("focused-info bs-callout-info");
            $("table#" + i + ".sent .btn-group input:not(:checked)").closest(".btn-group").removeClass("focused-info bs-callout-info");
        };

        const addFocus = function (i, x) {
            $("table#" + i + ".sent .btn-group input:checked").closest(".btn-group").addClass("focused-success bs-callout-success");
            $("table#" + i + ".sent .btn-group input:not(:checked)").closest(".btn-group").removeClass("focused-success bs-callout-success");
        };

        const addZero = function (i, x) {
            $("#addZeroModel").on('show.bs.modal', function (event) {
                var button = $(event.relatedTarget);
                var recipient = button.data('whatever');
                var modal = $(this);
                console.log();
                var word_texts = $("table#" + i + ".sent .btn-group input:checked").siblings().find("td.word_text").map(function () {
                    return $(this).text();
                }).toArray();
                modal.find("#target").text(word_texts.join(" "));
            });
            //$(x).prop("disabled", true);
            //$("table#" + i + ".sent td.word_text").prepend('<button onclick="selectAnt()" class="btn btn-info" style="padding:0">(?)</button> ');
        };

        const selectAnt = function () {
            console.log("select antecedent");
        };

        const delAnnotaion = function (i, x) {
            console.log($("table#" + i + ".sent"));
        };

        {% comment %}$(".word").mousedown(function () {
            $(this).prepend("{");
        }).mouseup(function () {
            $(this).append("}");
        });{% endcomment %}

        const test = function () {
            console.log("autosave1 = " + $(":radio[name=autosave]:checked").val());
            console.log("autosave2 = " + autosave);
            console.log("taskdone1 = " + $(":radio[name=taskdone]:checked").val());
            console.log("taskdone2 = " + taskdone);
        };

        $(function () {
            $("#username").text(username);
            const sent_td = $("td.sent");
            const offset = sent_td.offset().left;
            autosave = $(":radio[name=autosave]:checked").val() === "yes";
            taskdone = $(":radio[name=taskdone]:checked").val() === "yes";
            var max_h, act_h, h, d;

            {% for sent in textcont.sents %}
                max_h = Math.ceil(Math.pow($("#{{ sent.id }}.sent").width(), 0.75) - Math.pow($("#{{ sent.id }}.sent").width(), 0.95) / 12);
                act_h = 0;
                sent_td.width(document.body.clientWidth - 1);
                $("div#{{ sent.id }}.deps").append('<canvas id="{{ sent.id }}" class="deps" width="' + sent_td.width() + '" height="' + max_h + '" style="position:relative; top:11px;">');
                {% for word in sent.words %}
                    {% if word.head > 0 %}
                        h = linkTwo($("canvas#{{ sent.id }}.deps")[0], offset, $("#{{ sent.id }}.sent #{{ word.id }}.word"), $("#{{ sent.id }}.sent #{{ word.head }}.word"), max_h);
                        act_h = Math.max(act_h, h);
                    {% endif %}
                {% endfor %}
                d = -(max_h - act_h - 5);
                $("div#{{ sent.id }}.deps").css("height", act_h + 10).css("position", "relative").css("top", d);
            {% endfor %}

            $("label.autosave, label.taskdone, label.zerotype").click(function () {
                $(this).removeClass("btn-default").addClass("btn-primary");
                $(this).siblings().removeClass("btn-primary").addClass("btn-default");
                setTimeout(function () {
                    {#                    $("#list").focus();#}
                    autosave = $(":radio[name=autosave]:checked").val() === "yes";
                    taskdone = $(":radio[name=taskdone]:checked").val() === "yes";
                }, 1);
            });

            $("label.word").click(function () {
                var sent_id = $(this).parents().closest("table.sent").attr("id")
                setTimeout(function () {
                    {#                    $("td#" + sent_id + ".cmd button.cmd2").focus();#}
                }, 1);
            });

            //$("input[name=autosave]").attr("disabled", true);
        });
    </script>
    <style>
        .focused-info {
            border-color: #ccc;
            border-color: rgba(82, 168, 236, .8);
            outline: 0;
            outline: thin dotted \9;
            -webkit-box-shadow: 0 0 8px rgba(82, 168, 236, .6);
            box-shadow: 0 0 8px rgba(82, 168, 236, .6);
        }

        .focused-success {
            border-color: #ccc;
            border-color: rgba(90, 236, 98, 0.8);
            outline: 0;
            outline: thin dotted \9;
            -webkit-box-shadow: 0 0 8px rgba(90, 236, 98, .6);
            box-shadow: 0 0 8px rgba(90, 236, 98, .6);
        }

        .bs-callout {
            border: 1px solid transparent;
            border-left-width: 7px;
            border-radius: 5px;
        }

        .bs-callout-info {
            border: 1px solid #1b809e;
            border-left-width: 7px;
            border-left-color: #1b809e;
        }

        .bs-callout-success {
            border: 1px solid #5b9d5f;
            border-left-width: 7px;
            border-left-color: #5b9d5f;
        }

        .bs-callout-danger {
            border: 1px solid #ce4844;
            border-left-width: 7px;
            border-left-color: #ce4844;
        }

        .bs-callout-warning {
            border: 1px solid #aa6708;
            border-left-width: 7px;
            border-left-color: #aa6708;
        }

    </style>
{% endblock script_header %}

{% block header %}
{% endblock header %}

{% block body %}
    <div style="margin-top:10px; margin-left:10px; margin-bottom:30px; color:black">
        <div style="display:inline-block; font-size:16pt; font-weight:bold; position:relative; top:3px; margin-right:10px;">
            생략어 복원 Annotation
        </div>

        <div class="well well-sm"
             style="display:inline-block; text-align:center; font-size:11pt; width:400px; height:35px; margin-bottom:0">
            <i class="glyphicon glyphicon-file"> </i>
            <span id="textname">{{ textname }}</span>
        </div>

        <div class="btn-group" data-toggle="buttons" style="position:relative; top:-4px;">
            <label class="autosave btn btn-primary active">
                <input type="radio" name="autosave" style="display:none" value="yes" checked><i
                    class="glyphicon glyphicon-floppy-saved"><span
                    style="padding-left:3px; font-size:10.5pt; position:relative; top:-2px;">저장</span></i>
            </label>
            <label class="autosave btn btn-default">
                <input type="radio" name="autosave" style="display:none" value="no"><i
                    class="glyphicon glyphicon-floppy-remove"><span
                    style="padding-left:3px; font-size:10.5pt; position:relative; top:-2px;">연습</span></i>
            </label>
        </div>

        <div class="btn-group" data-toggle="buttons" style="position:relative; top:-4px;">
            <label class="taskdone btn btn-primary active">
                <input type="radio" name="taskdone" style="display:none" value="no" checked><i
                    class="glyphicon glyphicon-pencil"><span
                    style="padding-left:3px; font-size:10.5pt; position:relative; top:-2px;">진행</span></i>
            </label>
            <label class="taskdone btn btn-default">
                <input type="radio" name="taskdone" style="display:none" value="yes"><i
                    class="glyphicon glyphicon-lock"><span
                    style="padding-left:3px; font-size:10.5pt; position:relative; top:-2px;">완료</span></i>
            </label>
        </div>

        <button id="test" onclick="test()" class="btn btn-info" style="width:70px; position:relative; top:-4px;">
            <i class="glyphicon glyphicon-info-sign"><span
                    style="padding-left:3px; font-size:10.5pt; position:relative; top:-2px;">확인</span></i>
        </button>

        <button id="list" onclick="goList()" class="btn btn-warning" style="width:70px; position:relative; top:-4px;">
            <i class="glyphicon glyphicon-th-list"><span
                    style="padding-left:3px; font-size:10.5pt; position:relative; top:-2px;">목록</span></i>
        </button>

        <div class="well well-sm"
             style="display:inline-block; text-align:center; font-size:11pt; width:350px; height:35px; margin-bottom:0">
            <i class="glyphicon glyphicon-user"> </i>
            <span id="username"></span>
        </div>

        <button id="exit" onclick="doLogout()" class="btn btn-danger" style="width:70px; position:relative; top:-4px;">
            <i class="glyphicon glyphicon-off"><span
                    style="padding-left:3px; font-size:10.5pt; position:relative; top:-2px;">종료</span></i>
        </button>
    </div>

    <table class="table table-condensed table-striped list" style="display:inline-block; width:max-content;">
        <tr>
            <th style="text-align:right; padding-right:8px;">id</th>
            <th style="text-align:center;">command</th>
            <th style="text-align:center;">sentence</th>
        </tr>
        {% for sent in textcont.sents %}
            <tr>
                <th style="text-align:right; vertical-align:top; padding-top:5px">{{ sent.id }}</th>
                <td class="cmd" id="{{ sent.id }}" style="text-align:right; vertical-align:top; padding-top:5px">
                    <table align="center">
                        <tr>
                            <td style="padding:1px">
                                <button onclick="showDeps({{ sent.id }})" class="cmd1 btn btn-sm btn-warning">
                                    <i class="glyphicon glyphicon-search"><span
                                            style="padding-left:3px; font-size:9.5pt; position:relative; top:-2px;">의존성</span></i>
                                </button>
                            </td>
                            <td style="padding:1px">
                                <button onclick="addAnte({{ sent.id }}, this)" class="cmd2 btn btn-sm btn-primary">
                                    <i class="glyphicon glyphicon-tag"><span
                                            style="padding-left:3px; font-size:9.5pt; position:relative; top:-2px;">선행어</span></i>
                                </button>
                            </td>
                        </tr>
                        <tr>
                            <td style="padding:1px">
                                <button onclick="addFocus({{ sent.id }}, this)" class="cmd3 btn btn-sm btn-success">
                                    <i class="glyphicon glyphicon-tag"><span
                                            style="padding-left:3px; font-size:9.5pt; position:relative; top:-2px;">포커스</span></i>
                                </button>
                            </td>
                            <td style="padding:1px">
                                <button onclick="addZero({{ sent.id }}, this)" class="cmd4 btn btn-sm btn-info"
                                        data-toggle="modal" data-target="#addZeroModel" data-whatever="test">
                                    <i class="glyphicon glyphicon-tag"><span
                                            style="padding-left:3px; font-size:9.5pt; position:relative; top:-2px;">생략어</span></i>
                                </button>
                            </td>
                        </tr>
                    </table>
                </td>
                <td class="sent" id="{{ sent.id }}" style="line-height:150%; padding-top:5px; vertical-align:middle;">
                    <div class="deps" id="{{ sent.id }}" style="display:none;"></div>
                    <table class="sent" id="{{ sent.id }}">
                        <tr>
                            {% for word in sent.words %}
                                <td>
                                    <div class="btn-group bs-callout  {% comment %}focused bs-callout-info{% endcomment %}"
                                         data-toggle="buttons"
                                         style="display:inline-block; width:max-content; padding:5px; margin-right:8px;">
                                        <label class="word btn btn-default"
                                               style="padding:5px 3px 0 3px;">
                                            <input type="checkbox" style="display:none">
                                            <table class="word" id="{{ word.id }}"
                                                   style="display:inline-block; width:max-content; padding:0; margin:0;">
                                                <tr>
                                                    <td class="word_label"
                                                        style="text-align:center; font-size:9pt; font-family:Consolas; color:{{ word.label_color }}">{{ word.label }}</td>
                                                </tr>
                                                <tr>
                                                    <td class="word_text"
                                                        style="font-size:10pt; padding-left:10px; padding-right:10px;">{{ word.text }}</td>
                                                </tr>
                                            </table>
                                        </label>
                                        {% comment %}<label class="word btn btn-default">
                                            <input type="checkbox">
                                            <table class="word" id="{{ word.id }}"
                                                   style="display:inline-block; width:max-content; padding:0; margin:0;">
                                                <tr>
                                                    <td class="word_label"
                                                        style="text-align:center; font-size:9pt; font-family:Consolas; color:{{ word.label_color }}">{{ word.label }}</td>
                                                </tr>
                                                <tr>
                                                    <td class="word_text"
                                                        style="font-size:10pt; padding-left:10px; padding-right:10px;">{{ word.text }}</td>
                                                </tr>
                                            </table>
                                        </label>{% endcomment %}
                                    </div>

                                </td>
                            {% endfor %}
                        </tr>
                    </table>
                </td>
            </tr>
        {% endfor %}
    </table>

    <div style="padding-bottom:300px"></div>

    <div class="modal fade" id="addZeroModel" tabindex="-1" role="dialog" aria-labelledby="addZeroModelLabel" style="top:150px;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                    <h4 class="modal-title">생략어 추가</h4>
                </div>
                <div class="modal-body">
                    <table class="table list">
                        <tr>
                            <th style="width:100px">대상 텍스트</th>
                            <td id="target">?</td>
                        </tr>
                        <tr>
                            <th style="width:100px">생략어 종류</th>
                            <td>
                                <div class="btn-group" data-toggle="buttons" style="position:relative; top:4px; margin-bottom: 10px;">
                                    <label class="zerotype btn btn-primary active">
                                        <input type="radio" name="zerotype" style="display:none" value="yes" checked><i
                                            class="glyphicon glyphicon-comment"><span
                                            style="padding-left:3px; font-size:10.5pt; position:relative; top:-2px;">주어</span></i>
                                    </label>
                                    <label class="zerotype btn btn-default">
                                        <input type="radio" name="zerotype" style="display:none" value="no"><i
                                            class="glyphicon glyphicon-comment"><span
                                            style="padding-left:3px; font-size:10.5pt; position:relative; top:-2px;">목적어</span></i>
                                    </label>
                                    <label class="zerotype btn btn-default">
                                        <input type="radio" name="zerotype" style="display:none" value="no"><i
                                            class="glyphicon glyphicon-comment"><span
                                            style="padding-left:3px; font-size:10.5pt; position:relative; top:-2px;">관형어</span></i>
                                    </label>
                                </div>
                            </td>
                        </tr>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" data-dismiss="modal">적용</button>
                </div>
            </div>
        </div>
    </div>
{% endblock body %}
