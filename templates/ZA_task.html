{% extends "index.html" %}

{% block script_header %}
    <style type="text/css">
        .tagged-none {
            border: 1px solid transparent;
            border-left-width: 7px;
            border-radius: 5px;
        }

        .tagged-fade {
            border: 1px solid lightgray;
            border-left-width: 7px;
            border-radius: 5px;
        }

        .tagged-primary {
            border-color: #ccc;
            border-color: rgba(56, 124, 183, 0.8);
            outline: 0;
            outline: thin dotted \9;
            -webkit-box-shadow: 0 0 8px rgba(56, 124, 183, .6);
            box-shadow: 0 0 8px rgba(56, 124, 183, .6);
        }

        .tagged-success {
            border-color: #ccc;
            border-color: rgba(82, 171, 82, 0.8);
            outline: 0;
            outline: thin dotted \9;
            -webkit-box-shadow: 0 0 8px rgba(82, 171, 82, .6);
            box-shadow: 0 0 8px rgba(82, 171, 82, .6);
        }
    </style>

    <script type="text/javascript">
        var entities = JSON.parse("{{ entities|escapejs }}");
        var relations = JSON.parse("{{ relations|escapejs }}");

        var title = "{{ title|safe }}";
        var textcont = {# {{ textcont2|safe }} #} JSON.parse("{{ textcont2|escapejs }}");

        var autosave = undefined;
        var taskdone = undefined;
        var zerotype = undefined;
        var antecand = undefined;
        var antecedents = {};
        var zeroanaphora = {};

        antecedents["[TITLE]"] = {ant_text: title, ant_sid: -1, ant_wid: -1, ant_is_title: 1};
        antecedents["[UNKNOWN]"] = {ant_text: "[Unknown]", ant_sid: -1, ant_wid: -1, ant_is_title: 0};
        textcont["sents"].forEach(function (x) {
            zeroanaphora[x["id"]] = {};
        });
        console.log("antecedents = ", antecedents);
        console.log("zeroanaphora = ", zeroanaphora);
        console.log("entities = ", entities);
        console.log("relations = ", relations);

        if (!getAuthCode())
            window.location = "/login/";
        $.ajax({
            url: "/ZA/",
            type: "get",
            async: true,
            beforeSend: function (req) {
                req.setRequestHeader("Authorization", authcode);
            }
        });

        const test = function () {
            console.log("autosave1 = " + $(":radio[name=autosave]:checked").val());
            console.log("autosave2 = " + autosave);
            console.log("taskdone1 = " + $(":radio[name=taskdone]:checked").val());
            console.log("taskdone2 = " + taskdone);
            console.log("zerotype1 = " + $(":radio[name=zerotype]:checked").val());
            console.log("zerotype2 = " + zerotype);

            $('label#1_1[data-toggle="popover"]').popover('show');
        };

        const goList = function () {
            window.location = "/ZA/";
        };

        const showDeps = function (i) {
            $("div#" + i + ".deps").slideToggle("slow");
        };

        $(function () {
            for (var x in entities) {
                var i = entities[x]["ant_sid"];
                var j = entities[x]["ant_wid"];
                if (i >= 0 && j >= 0)
                    addAnte(i, j);
            }

            $("#username").text(username);
            const sent_td = $("td.sent");
            const offset = sent_td.offset().left;
            autosave = $(":radio[name=autosave]:checked").val() === "yes";
            taskdone = $(":radio[name=taskdone]:checked").val() === "yes";
            zerotype = $(":radio[name=zerotype]:checked").val();
            var max_h, act_h, h, d;

            {% for sent in textcont.sents %}
                max_h = Math.ceil(Math.pow($("#{{ sent.id }}.sent").width(), 0.75) - Math.pow($("#{{ sent.id }}.sent").width(), 0.95) / 12);
                act_h = 0;
                sent_td.width(document.body.clientWidth - 1);
                $("div#{{ sent.id }}.deps").append('<canvas id="{{ sent.id }}" class="deps" width="' + sent_td.width() + '" height="' + max_h + '" style="position:relative; top:11px;">');
                {% for word in sent.words %}
                    {% if word.head >= 0 %}
                        h = linkTwo($("canvas#{{ sent.id }}.deps")[0], offset, $("#{{ sent.id }}.sent #{{ word.id }}.word"), $("#{{ sent.id }}.sent #{{ word.head }}.word"), max_h);
                        act_h = Math.max(act_h, h);
                    {% endif %}
                {% endfor %}
                d = -(max_h - act_h - 5);
                $("div#{{ sent.id }}.deps").css("height", act_h + 10).css("position", "relative").css("top", d);
            {% endfor %}

            $(":checkbox[name=word]").change(function () {
                if (this.checked)
                    $(this).parent().popover("show");
                else
                    $(this).parent().popover("hide");
            });

            $("[data-toggle=popover]").popover({container: "body", trigger: "manual"});

            $("label.word").click(function () {
                var sent_id = $(this).parents().closest("table.sent").attr("id");
                setTimeout(function () {
                    $("td#" + sent_id + ".cmd button.cmd4").focus();
                }, 1);
            });

            $("label.autosave").click(function () {
                $(this).removeClass("btn-default").addClass("btn-primary");
                $(this).siblings().removeClass("btn-primary").addClass("btn-default");
                setTimeout(function () {
                    autosave = $(":radio[name=autosave]:checked").val() === "yes";
                }, 1);
            });

            $("label.taskdone").click(function () {
                $(this).removeClass("btn-default").addClass("btn-primary");
                $(this).siblings().removeClass("btn-primary").addClass("btn-default");
                setTimeout(function () {
                    taskdone = $(":radio[name=taskdone]:checked").val() === "yes";
                }, 1);
            });

            $("label.zerotype").click(function () {
                $(this).removeClass("btn-default").addClass("btn-primary");
                $(this).siblings().removeClass("btn-primary").addClass("btn-default");
                setTimeout(function () {
                    zerotype = $(":radio[name=zerotype]:checked").val();
                }, 1);
            });

            $("#addZeroModel")
                .on("show.bs.modal", function (e) {
                    $(":checkbox[name=word]:checked").click();
                    var head = $(e.relatedTarget);
                    var modal = $(this);
                    modal.find("span#head_text").text(head.data("text"));
                    modal.find("span#head_sid").text(head.data("sid"));
                    modal.find("span#head_wid").text(head.data("wid"));
                    modal.find("td#ante").html('<div id="ante" class="btn-group" data-toggle="buttons" style="position:relative; top:4px; margin-bottom: 10px;"></div>');
                    for (var k in antecedents) {
                        var a = antecedents[k]["ant_text"];
                        var b = antecedents[k]["ant_sid"];
                        var c = antecedents[k]["ant_wid"];
                        modal.find("div#ante").append(
                            '<label class="antecand btn btn-default"><input type="radio" name="antecand" style="display:none" value="' + k + '">' +
                            '<span style="padding-left:3px; font-size:10.5pt; position:relative; top:-2px;">' + a + '<sub>(' + b + ',' + c + ')</sub></span>' +
                            '</label>');
                    }

                    $("label.antecand").click(function () {
                        $(this).removeClass("btn-default").addClass("btn-primary");
                        $(this).siblings().removeClass("btn-primary").addClass("btn-default");
                        setTimeout(function () {
                            antecand = $(":radio[name=antecand]:checked").val();
                        }, 1);
                    });

                    $("label.zerotype").first().click();
                    $("label.antecand").first().click();
                })
                .on("hide.bs.modal", function () {
                    var ant = antecedents[antecand];
                    var head = {
                        head_sid: Number($("span#head_sid").text()),
                        head_wid: Number($("span#head_wid").text())
                    };
                    var za = {
                        "id": Object.keys(zeroanaphora[head["head_sid"]]).length,
                        "type": zerotype,
                        head_wid: head["head_wid"],
                        ant_text: ant["ant_text"],
                        ant_sid: ant["ant_sid"],
                        ant_wid: ant["ant_wid"],
                        ant_is_title: ant["ant_is_title"]
                    };
                    zeroanaphora[head["head_sid"]][za["id"]] = za;
                    console.log("zeroanaphora = ", zeroanaphora);
                    {# TODO: addZero로 zero 태깅 기능 옮기고 시각화 구현하기!!! #}
                    {% comment %}
                    var sent = textcont["sents"][head["head_sid"]];
                    if (!("ZA" in sent))
                        sent["ZA"] = [];
                    sent["ZA"].push(za);
                    console.log(sent);
                    console.log(textcont);
                    {% endcomment %}
                    saveAnn();
                });
        });

        const addAnte = function (i, j) {
            var id = i + "-" + j;
            var label = $("label#" + id);
            label.parent().toggleClass("tagged-primary");
            if (label.parent().hasClass("tagged-primary"))
                antecedents[id] = {ant_text: label.attr("data-text"), ant_sid: i, ant_wid: j, ant_is_title: 0};
            else
                delete antecedents[id];
            $(":checkbox[name=word]:checked").click();
            $("[data-toggle=popover]").popover("hide");
            console.log("antecedents = ", antecedents);
            console.log("antecedents.keys() = ", Object.keys(antecedents));
        };

        const addZero = function (i, x) {
            //$(x).prop("disabled", true);
            //$("table#" + i + ".sent td.word_text").prepend('<button onclick="selectAnt()" class="btn btn-info" style="padding:0">(?)</button> ');
        };

        const saveAnn = function () {
            $.ajax({
                url: "{{ textname }}/save/",
                type: "post",
                async: true,
                data: {
                    entities: JSON.stringify(antecedents),
                    relations: JSON.stringify(zeroanaphora)
                },
                beforeSend: function (req) {
                    req.setRequestHeader("Authorization", authcode);
                },
                success: function () {
                    alert("Annotation 기록이 모두 저장되었습니다.");
                },
                error: function () {
                    alert("저장에 실패하였습니다. 서버에 문제가 있는 것 같습니다. 담당자에게 연락 바랍니다.");
                }
            });
        };

    </script>
{% endblock script_header %}

{% block header %}
{% endblock header %}

{% block body %}
    <div style="margin-top:10px; margin-left:10px; margin-bottom:30px; color:black">
        <div style="display:inline-block; font-size:16pt; font-weight:bold; position:relative; top:3px; margin-right:10px;">
            생략어 복원 Annotation
        </div>

        <div class="well well-sm" style="display:inline-block; text-align:center; font-size:11pt; width:400px; height:35px; margin-bottom:0">
            <i class="glyphicon glyphicon-file"> </i> <span id="textname">{{ textname }}</span>
        </div>

        <div class="btn-group" data-toggle="buttons" style="position:relative; top:-4px;">
            <label class="autosave btn btn-primary active">
                <input type="radio" name="autosave" style="display:none" value="yes" checked>
                <i class="glyphicon glyphicon-floppy-saved"><span style="padding-left:3px; font-size:10.5pt; position:relative; top:-2px;">저장</span></i>
            </label>
            <label class="autosave btn btn-default">
                <input type="radio" name="autosave" style="display:none" value="no">
                <i class="glyphicon glyphicon-floppy-remove"><span style="padding-left:3px; font-size:10.5pt; position:relative; top:-2px;">연습</span></i>
            </label>
        </div>

        <div class="btn-group" data-toggle="buttons" style="position:relative; top:-4px;">
            <label class="taskdone btn btn-primary active">
                <input type="radio" name="taskdone" style="display:none" value="no" checked>
                <i class="glyphicon glyphicon-pencil"><span style="padding-left:3px; font-size:10.5pt; position:relative; top:-2px;">진행</span></i>
            </label>
            <label class="taskdone btn btn-default">
                <input type="radio" name="taskdone" style="display:none" value="yes">
                <i class="glyphicon glyphicon-lock"><span style="padding-left:3px; font-size:10.5pt; position:relative; top:-2px;">완료</span></i>
            </label>
        </div>

        <button id="test" onclick="test()" class="btn btn-info" style="width:70px; position:relative; top:-4px;">
            <i class="glyphicon glyphicon-info-sign"><span style="padding-left:3px; font-size:10.5pt; position:relative; top:-2px;">확인</span></i>
        </button>

        <button id="list" onclick="goList()" class="btn btn-warning" style="width:70px; position:relative; top:-4px;">
            <i class="glyphicon glyphicon-th-list"><span style="padding-left:3px; font-size:10.5pt; position:relative; top:-2px;">목록</span></i>
        </button>

        <div class="well well-sm" style="display:inline-block; text-align:center; font-size:11pt; width:350px; height:35px; margin-bottom:0">
            <i class="glyphicon glyphicon-user"> </i> <span id="username"></span>
        </div>

        <button id="exit" onclick="doLogout()" class="btn btn-danger" style="width:70px; position:relative; top:-4px;">
            <i class="glyphicon glyphicon-off"><span style="padding-left:3px; font-size:10.5pt; position:relative; top:-2px;">종료</span></i>
        </button>
    </div>

    <table class="table table-condensed table-striped list" style="display:inline-block; width:max-content;">
        <tr>
            <th style="text-align:right; padding-right:8px;">id</th>
            <th style="text-align:center;">command</th>
            <th style="text-align:center;">sentence</th>
        </tr>
        {% for sent in textcont.sents %}
            <tr>
                <th style="text-align:right; vertical-align:top; padding-top:5px">{{ sent.id }}</th>
                <td class="cmd" id="{{ sent.id }}" style="text-align:right; vertical-align:top; padding-top:5px">
                    <table align="center">
                        <tr>
                            <td style="padding:1px">
                                <button onclick="showDeps({{ sent.id }})" class="cmd1 btn btn-sm btn-warning">
                                    <i class="glyphicon glyphicon-search"><span style="padding-left:3px; font-size:9.5pt; position:relative; top:-2px;">의존성</span></i>
                                </button>
                            </td>
                            {% comment %}
                            <td style="padding:1px">
                                <button onclick="addAnte({{ sent.id }}, this)" class="cmd2 btn btn-sm btn-primary">
                                    <i class="glyphicon glyphicon-tag"><span style="padding-left:3px; font-size:9.5pt; position:relative; top:-2px;">선행어</span></i>
                                </button>
                            </td>
                            {% endcomment %}
                        </tr>
                        {% comment %}
                        <tr>
                            <td style="padding:1px">
                                <button onclick="addFocus({{ sent.id }}, this)" class="cmd3 btn btn-sm btn-success">
                                    <i class="glyphicon glyphicon-tag"><span style="padding-left:3px; font-size:9.5pt; position:relative; top:-2px;">포커스</span></i>
                                </button>
                            </td>
                            <td style="padding:1px">
                                <button onclick="addZero({{ sent.id }}, this)" class="cmd4 btn btn-sm btn-info" data-toggle="modal" data-target="#addZeroModel" data-whatever="{{ sent.id }}">
                                    <i class="glyphicon glyphicon-tag"><span style="padding-left:3px; font-size:9.5pt; position:relative; top:-2px;">생략어</span></i>
                                </button>
                            </td>
                        </tr>
                        {% endcomment %}
                    </table>
                </td>
                <td class="sent" id="{{ sent.id }}" style="line-height:150%; padding-top:5px; vertical-align:middle;">
                    <div class="deps" id="{{ sent.id }}" style="display:none;"></div>
                    <table class="sent" id="{{ sent.id }}">
                        <tr>
                            {% for word in sent.words %}
                                <td style="padding-right:8px;">
                                    <div class="btn-group tagged-none" style="padding:3px">
                                        <div class="btn-group tagged-none" data-toggle="buttons" style="padding:3px">
                                            <label class="word btn btn-default" id="{{ sent.id }}-{{ word.id }}" style="padding:3px 1px 0 1px"
                                                   data-toggle="popover" data-placement="top" data-html="true" data-text="{{ word.text }}"
                                                   data-content='
                                                    <button onclick="addAnte({{ sent.id }}, {{ word.id }})" class="cmd2 btn btn-sm btn-primary">
                                                        <i class="glyphicon glyphicon-tag"><span style="padding-left:3px; font-size:9.5pt; position:relative; top:-2px;">선행어</span></i>
                                                    </button>
                                                    <button onclick="addZero({{ sent.id }}, {{ word.id }})" class="cmd4 btn btn-sm btn-info"
                                                        data-toggle="modal" data-target="#addZeroModel"
                                                        data-text="{{ word.text }}" data-sid="{{ sent.id }}" data-wid="{{ word.id }}">
                                                        <i class="glyphicon glyphicon-tag"><span style="padding-left:3px; font-size:9.5pt; position:relative; top:-2px;">생략어</span></i>
                                                    </button>
                                                   '>
                                                <input type="checkbox" name="word" style="display:none" value="{{ sent.id }}-{{ word.id }}">
                                                <table class="word" id="{{ word.id }}" style="display:inline-block; width:max-content; padding:0; margin:0">
                                                    <tr>
                                                        <td class="word_label" style="text-align:center; font-size:9pt; font-family:Consolas; color:{{ word.label_color }}">{{ word.label }}</td>
                                                    </tr>
                                                    <tr>
                                                        <td class="word_text" style="font-size:10pt; padding-left:10px; padding-right:10px;">{{ word.text }}</td>
                                                    </tr>
                                                </table>
                                            </label>
                                        </div>
                                    </div>
                                </td>
                            {% endfor %}
                        </tr>
                    </table>
                </td>
            </tr>
        {% endfor %}
    </table>

    <div class="modal fade" id="addZeroModel" tabindex="-1" role="dialog" aria-labelledby="addZeroModelLabel" style="top:150px">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                    <h4 class="modal-title">생략어 추가</h4>
                </div>
                <div class="modal-body">
                    <table class="table list table-hover">
                        <tr>
                            <th style="width:100px">지배소</th>
                            <td>
                                <span id="head_text"></span><sub>(<span id="head_sid"></span>,<span id="head_wid"></span>)</sub>
                            </td>
                        </tr>
                        <tr>
                            <th style="width:100px">생략어 종류</th>
                            <td>
                                <div class="btn-group" data-toggle="buttons"
                                     style="position:relative; top:4px; margin-bottom: 10px;">
                                    <label class="zerotype btn btn-default">
                                        <input type="radio" name="zerotype" style="display:none" value="s">
                                        <i class="glyphicon glyphicon-comment">
                                            <span style="padding-left:3px; font-size:10.5pt; position:relative; top:-2px;">주어</span>
                                        </i>
                                    </label>
                                    <label class="zerotype btn btn-default">
                                        <input type="radio" name="zerotype" style="display:none" value="o">
                                        <i class="glyphicon glyphicon-comment">
                                            <span style="padding-left:3px; font-size:10.5pt; position:relative; top:-2px;">목적어-및-필수-부사어</span>
                                        </i>
                                    </label>
                                    <label class="zerotype btn btn-default">
                                        <input type="radio" name="zerotype" style="display:none" value="a">
                                        <i class="glyphicon glyphicon-comment">
                                            <span style="padding-left:3px; font-size:10.5pt; position:relative; top:-2px;">관형어</span>
                                        </i>
                                    </label>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <th style="width:100px">선행어</th>
                            <td id="ante">?</td>
                        </tr>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" data-dismiss="modal">적용</button>
                </div>
            </div>
        </div>
    </div>
{% endblock body %}
